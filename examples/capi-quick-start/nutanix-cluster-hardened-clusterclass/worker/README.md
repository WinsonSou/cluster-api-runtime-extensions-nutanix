# Hardened Kubernetes Worker Node Template

This directory contains kustomization files to apply CIS security mitigations to the Kubernetes worker node template.

## Prerequisites

Before applying the kustomization, you need to determine the available Nutanix-provided KubeadmConfigTemplates (those with the "nkp-" prefix) and their versions:

```bash
# List all available KubeadmConfigTemplates
kubectl get kubeadmconfigtemplates.bootstrap.cluster.x-k8s.io

# Example output:
# NAME                         AGE
# nkp-nutanix-worker-v2.14.0   4d
# wskn-nkp-mgmt-md-0-4phrm     19h
```

**Important**: You must use the Nutanix-provided template (starting with "nkp-") for these hardening configurations to work correctly.

Then export the original Nutanix KubeadmConfigTemplate using the appropriate version:

```bash
# Replace <VERSION> with your actual version (e.g., v2.14.0)
kubectl get kubeadmconfigtemplates.bootstrap.cluster.x-k8s.io nkp-nutanix-worker-<VERSION> -o yaml > nkp-nutanix-worker-<VERSION>.yaml
```

## Structure

- `nkp-nutanix-worker-<VERSION>.yaml` - The original KubeadmConfigTemplate (generated by user, replace <VERSION> with your actual version)
- `cis-mitigations-worker-patch.yaml` - Patch file containing CIS hardening configurations
- `kustomization.yaml` - Kustomization file that applies the patch and renames the template

**Note**: You need to edit BOTH of these files with your actual version:

1. Edit the `cis-mitigations-worker-patch.yaml` file to replace `<VERSION>` with your actual version in the `metadata.name` field:  

```yaml
apiVersion: bootstrap.cluster.x-k8s.io/v1beta1
kind: KubeadmConfigTemplate
metadata:
  name: nkp-nutanix-worker-<VERSION>  # <-- Replace <VERSION> with your actual version
```

2. Edit the `kustomization.yaml` file to replace `<VERSION>` in the resources section: 

```yaml
resources:
- nkp-nutanix-worker-<VERSION>.yaml  # <-- Replace <VERSION> with your actual version
```

## Applying the Kustomization

You can apply this kustomization directly with kubectl:

```bash
kubectl apply -k /path/to/hardened-clusters/kustomize/worker
```

Or you can build and then apply:

```bash
# If you have kustomize installed separately
kustomize build /path/to/hardened-clusters/kustomize/worker | kubectl apply -f -

# Or using kubectl's built-in kustomize
kubectl kustomize /path/to/hardened-clusters/kustomize/worker | kubectl apply -f -
```

## Verification

The kustomization will:

1. Take the user-generated KubeadmConfigTemplate `nkp-nutanix-worker-<VERSION>`
2. Apply the CIS mitigations patch that adds:
   - Kubelet security settings (read-only port, connection timeout, iptables)
   - Resource limit configurations
   - Enhanced TLS cipher configuration
   - Additional postKubeadmCommands for file permission hardening
3. Rename it to `nkp-nutanix-worker-<VERSION>-hardened`

## CIS Mitigations Applied

The following CIS mitigations are applied:

- **4.1.1**: Set kubelet service file permissions to 600 or more restrictive
- **4.2.4**: Set read-only-port argument to 0
- **4.2.5**: Set streaming-connection-idle-timeout to non-zero value (5m as per CIS guidelines)
- **4.2.6**: Set make-iptables-util-chains argument to true
- **4.2.8**: Set event-qps argument to appropriate level (5)
- **4.2.12**: Enforce strong TLS cryptographic ciphers with an updated suite of recommended ciphers
- **4.2.13**: Set pod-max-pids limit to 4096

## Applying to Cluster Class

After generating the hardened template, you need to update the cluster class to use it:

1. First, identify the cluster class name and version:

```bash
kubectl get clusterclasses.cluster.x-k8s.io
```

2. Patch the cluster class to use the hardened worker template (replace `<VERSION>` and cluster class name as needed):

```bash
kubectl patch clusterclass nkp-nutanix-<VERSION> \
  --type json \
  -p='[{
    "op":"replace",
    "path":"/spec/workers/machineDeployments/0/template/bootstrap/ref/name",
    "value":"nkp-nutanix-worker-<VERSION>-hardened"
  }]'
```