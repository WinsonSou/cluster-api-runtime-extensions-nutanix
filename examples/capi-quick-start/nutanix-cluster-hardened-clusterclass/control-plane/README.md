# Hardened Kubernetes Control Plane Template

## Required Component: kubelet-csr-approver

To meet the following CIS security benchmarks:

- 1.2.5 Ensure that the --kubelet-certificate-authority argument is set as appropriate
- 1.3.6 Ensure that the RotateKubeletServerCertificate argument is set to true

You must install the Postfinance kubelet-csr-approver:

```bash
helm repo add kubelet-csr-approver https://postfinance.github.io/kubelet-csr-approver
helm upgrade --install kubelet-csr-approver \
  kubelet-csr-approver/kubelet-csr-approver \
  -n kube-system \
  --create-namespace \
  --set maxExpirationSeconds=2592000 \
  --set leaderElection=true \
  --set bypassDnsResolution=true \
  --set rbac.create=true
```

**Note**: If you choose not to install the kubelet-csr-approver, you must omit the flags related to the CIS benchmarks mentioned above from your configuration.

## Prerequisites

Before applying the kustomization, you need to determine the available Nutanix-provided KubeadmControlPlaneTemplates (those with the "nkp-" prefix) and their versions:

```bash
# List all available KubeadmControlPlaneTemplates
kubectl get kubeadmcontrolplanetemplates.controlplane.cluster.x-k8s.io

# Example output:
# NAME                     AGE
# nkp-nutanix-v2.14.0      4d
# some-other-template      19h
```

**Important**: You must use the Nutanix-provided template (starting with "nkp-") for these hardening configurations to work correctly.

Then export the original Nutanix KubeadmControlPlaneTemplate using the appropriate version:

```bash
# Replace <VERSION> with your actual version (e.g., v2.14.0)
kubectl get kubeadmcontrolplanetemplates.controlplane.cluster.x-k8s.io nkp-nutanix-<VERSION> -o yaml > nkp-nutanix-<VERSION>.yaml
```

## Structure

- `nkp-nutanix-<VERSION>.yaml` - The original KubeadmControlPlaneTemplate (generated by user, replace <VERSION> with your actual version)
- `cis-mitigations-cp-patch.yaml` - Patch file containing CIS hardening configurations
- `kustomization.yaml` - Kustomization file that applies the patch and renames the template

**Note**: You need to edit BOTH of these files with your actual version:

1. Edit the `cis-mitigations-cp-patch.yaml` file to replace `<VERSION>` with your actual version in the `metadata.name` field:

```yaml
apiVersion: controlplane.cluster.x-k8s.io/v1beta1
kind: KubeadmControlPlaneTemplate
metadata:
  name: nkp-nutanix-<VERSION>  # <-- Replace <VERSION> with your actual version
```

2. Edit the `kustomization.yaml` file to replace `<VERSION>` in the resources section:

```yaml
resources:
- nkp-nutanix-<VERSION>.yaml  # <-- Replace <VERSION> with your actual version
```

## Applying the Kustomization

You can apply this kustomization directly with kubectl:

```bash
#Ensure you are in a directory for the kustomization.yaml, cis-mitigations-cp-patch.yaml and the nkp-nutanix-<VERSION>.yaml file
kubectl apply -k .
```

## Verification

The kustomization will:

1. Take the user-generated KubeadmControlPlaneTemplate `nkp-nutanix-<VERSION>`
2. Apply the CIS mitigations patch that adds:
   - API Server hardening (profiling disabled, service account lookup, admission plugins)
   - Controller Manager settings (terminated pod GC threshold, profiling disabled)
   - Scheduler settings (profiling disabled)
   - Required configuration files for EventRateLimit
   - Additional postKubeadmCommands for file permission hardening
3. Rename it to `nkp-nutanix-<VERSION>-hardened`

## CIS Mitigations Applied

The following CIS mitigations are applied:

### API Server

- **1.2.15**: Disabled profiling for API server (`profiling: "false"`)
- **1.2.21**: Enabled service account lookup (`service-account-lookup: "true"`)
- **1.2.3, 1.2.9, 1.2.11, 1.2.14**: Added admission plugins:
  - AlwaysPullImages: Enforces that images are always pulled prior to starting containers
  - DenyServiceExternalIPs: Prevents services from using arbitrary external IPs
  - EventRateLimit: Mitigates event flooding attacks
  - NodeRestriction: Limits node access to specific APIs
- **1.2.9**: Configured EventRateLimit with appropriate admission control config file
- **1.2.5**: Set kubelet certificate authority (`kubelet-certificate-authority: /etc/kubernetes/pki/ca.crt`)
  - **Note**: This requires kubelet-csr-approver to be installed. If not installed, this flag should be omitted.

### Controller Manager

- **1.3.1**: Set terminated pod GC threshold to 10000 for better garbage collection
- **1.3.2**: Disabled profiling (`profiling: "false"`)
- **1.3.6**: Enabled RotateKubeletServerCertificate feature gate (`feature-gates: RotateKubeletServerCertificate=true`)
  - **Note**: This requires kubelet-csr-approver to be installed. If not installed, this flag should be omitted.

### Scheduler

- **1.4.1**: Disabled profiling (`profiling: "false"`)

### Kubelet Configuration (Both Init and Join)

- **1.2.5, 1.3.6**: Enabled kubelet server certificate rotation (`rotate-server-certificates: "true"`)
  - **Note**: This requires kubelet-csr-approver to be installed. If not installed, this flag should be omitted.

### EventRateLimit Configuration

- **1.2.9**: Created admission configuration files with detailed rate limits:
  - Server-wide: 5000 QPS with 20000 burst
  - Namespace: 500 QPS with 2000 burst (1000 cache size)
  - User: 100 QPS with 400 burst (2000 cache size)
  - SourceAndObject: 50 QPS with 100 burst (5000 cache size)

### File Permissions

- **4.1.1**: Set appropriate file permissions (0600) for sensitive files including:
  - kubelet.service
  - kubelet config.yaml
  - 10-kubeadm.conf

## Applying to Cluster Class

After generating the hardened template, you need to update the cluster class to use it:

1. First, identify the cluster class name and version:

```bash
kubectl get clusterclasses.cluster.x-k8s.io
```

2. Patch the cluster class to use the hardened control plane template (replace `<VERSION>` and cluster class name as needed):

```bash
kubectl patch clusterclass nkp-nutanix-<VERSION> \
  --type merge \
  -p='{"spec":{"controlPlane":{"ref":{"name":"nkp-nutanix-<VERSION>-hardened"}}}}'  
```
